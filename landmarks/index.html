<!DOCTYPE html>
<!ISSUES: me icon??, line to marker, render map order, clean up code!>
<html>

<head>
  <meta charset="utf-8">
	<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=true"></script>
  <title>Assignemnt 2</title>

  <link rel="stylesheet" href="style.css">
</head>

<body onload="initMap()">
<div id="map"> MAP </div>

<script>

var myLat = 0;
var myLng = 0;
var me = new google.maps.LatLng(myLat, myLng);
var map; 
var myOptions = {
						zoom: 13, // The larger the zoom number, the bigger the zoom
						center: me,
						mapTypeId: google.maps.MapTypeId.ROADMAP
					};

var infowindow = new google.maps.InfoWindow();

function initMap(){
        map = new google.maps.Map(document.getElementById("map"), myOptions); 
        getLocation();
}


function getLocation(){
	//console.log("test!"); 

	if (navigator.geolocation) { // the navigator.geolocation object is supported on your browser
					//get location and pass it to a function? 
					navigator.geolocation.getCurrentPosition(function(position) {
						myLat = position.coords.latitude;
						myLng = position.coords.longitude;
						//for testing purposes output it
						renderMap(); 
					});
				}
				else {
					alert("Geolocation is not supported by your web browser.  What a shame!");
				}
}


function sendLocation(){


	var myRequest = new XMLHttpRequest();
	 	myRequest.open("Post", "https://defense-in-derpth.herokuapp.com/sendLocation", true);
	 	myRequest.setRequestHeader("Content-type", "application/x-www-form-urlencoded"); 
	 	//convention on assignment sheet


		myRequest.onreadystatechange = function (){

	 		//data must be ready 
	 		if (myRequest.readyState == 4 && myRequest.status == 200) {

	 			//check if the data is bad
	 			raw = myRequest.responseText;
	 			theData = JSON.parse(raw);
	 			console.log(theData); 


				for(i=0; i<theData.people.length; i++){
					//console.log("looping"); 
					login = theData.people[i].login; 
					LatLng = {lat: theData.people[i].lat, lng: theData.people[i].lng};
			
					var distance = haversineDistance(myLng, myLat, theData.people[i].lng, theData.people[i].lat); 
					login+=" Distance:"+distance; 
					var m = makeMarker(login, LatLng); 
					//console.log(m);
	 			}  


				for(i=0; i<theData.landmarks.length; i++){
					var LatLng2 = {lat: theData.landmarks[i].geometry.coordinates[1],
						lng: theData.landmarks[i].geometry.coordinates[0]};
					//console.log(LatLng2); 

					var title= theData.landmarks[i].properties.Location_Name; 
					//console.log(title); 


					//make a marker if the landmark is in a one mile radius 
					var distance = haversineDistance(myLng, myLat, theData.landmarks[i].geometry.coordinates[0],
					 theData.landmarks[i].geometry.coordinates[1]); 
					title+=distance; 
					if (distance <= 1.0)
					{
							console.log(distance); 
							var m = makeMarker(title, LatLng2, "landmark");  
					}
				

					//console.log(m); 

					/*
					marker = new google.maps.Marker({
						position: LatLng2,
						title: title
					});


					marker.setMap(map);

					console.log("looping complete"); 

					// Open info window on click of marker
					google.maps.event.addListener(marker, 'click', function() {
						infowindow.setContent(this.title);
						infowindow.open(map, this);
					}); */ 
				} 


	 	}

	 	
	}

	myRequest.send("login=ELMER_MADDEN&lat="+myLat+"&lng="+myLng); 
	console.log("theoretically, you sent your location!");  
}

function renderMap(){
		me = new google.maps.LatLng(myLat, myLng);
		map.panTo(me);

		makeMarker("Here I Am!", me, "me"); 
        /*marker = new google.maps.Marker({
					position: me,
					title: "Here I Am!"
				});

				marker.setMap(map);
					
				// Open info window on click of marker
				google.maps.event.addListener(marker, 'click', function() {
					infowindow.setContent(marker.title);
					infowindow.open(map, marker);
				});*/ 
				sendLocation(); 
}

function makeMarker(title, LatLng, key){

	var image; 
	if (key == "me"){
		image = "http://ruralshores.com/assets/marker-icon.png"; 
	}
	if (key == "landmark"){
		image = "http://megaicons.net/static/img/icons_sizes/8/178/32/maps-and-geolocation-marker-icon.png"; 
	}

	var marker = new google.maps.Marker({
			position: LatLng,
			title: title, 
			icon: image
	});
	marker.setMap(map);

	google.maps.event.addListener(marker, 'click', function() {
						infowindow.setContent(this.title);
						infowindow.open(map, this);
	}); 
}
//NOTE: this is from stackoverflow,http://stackoverflow.com/questions/14560999/using-the-haversine-formula-in-javascript, modified slightly
function haversineDistance(lon1, lat1, lon2, lat2) {

var R = 6371; // km

  var x1 = lat2 - lat1;
  var dLat = toRad(x1);

  var x2 = lon2 - lon1;
  var dLon = toRad(x2); 

  var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
    Math.sin(dLon / 2) * Math.sin(dLon / 2);
  var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  var d = R * c;

  //convert to miles 
  d /= 1.60934;

  return d;
}

function toRad(x) {
    return x * Math.PI / 180;
  }

</script>


 
</body>

</html>