<!DOCTYPE html>
<!ISSUES: line to marker, render map order, image from folder,  

<head>
  <meta charset="utf-8">
	<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=true"></script>
  <title>Assignemnt 2</title>

  <link rel="stylesheet" href="style.css">
</head>

<body onload="initMap()">
<div id="map"> MAP </div>

<script>

var myLat = 0;
var myLng = 0;
var me = new google.maps.LatLng(myLat, myLng);
var map; 
var myOptions = {
						zoom: 13, // The larger the zoom number, the bigger the zoom
						center: me,
						mapTypeId: google.maps.MapTypeId.ROADMAP
					};
var contentString= ""; 
var infowindow = new google.maps.InfoWindow({
	content: contentString
});

function initMap(){
        map = new google.maps.Map(document.getElementById("map"), myOptions); 
        getLocation();
}


function getLocation(){
	//console.log("test!"); 

	if (navigator.geolocation) { // the navigator.geolocation object is supported on your browser
					//get location and pass it to a function? 
					navigator.geolocation.getCurrentPosition(function(position) {
						myLat = position.coords.latitude;
						myLng = position.coords.longitude;
						//for testing purposes output it
						renderMap(); 
					});
				}
				else {
					alert("Geolocation is not supported by your web browser.  What a shame!");
				}
}


function sendLocation(){


	var myRequest = new XMLHttpRequest();
	 	myRequest.open("Post", "https://defense-in-derpth.herokuapp.com/sendLocation", true);
	 	myRequest.setRequestHeader("Content-type", "application/x-www-form-urlencoded"); 
	 	//convention on assignment sheet


		myRequest.onreadystatechange = function (){

	 		//data must be ready 
	 		if (myRequest.readyState == 4 && myRequest.status == 200) {

	 			//check if the data is bad
	 			raw = myRequest.responseText;
	 			theData = JSON.parse(raw);
	 			console.log(theData); 


				for(i=0; i<theData.people.length; i++){
					//console.log("looping"); 
					login = theData.people[i].login; 
					LatLng = {lat: theData.people[i].lat, lng: theData.people[i].lng};
			
					var distance = haversineDistance(myLng, myLat, theData.people[i].lng, theData.people[i].lat); 
					login+=" Distance from me:"+distance; 
					if(theData.people[i].login!="ELMER_MADDEN"){
						var m = makeMarker(login, LatLng); 
					}
	 			}  



				for(i=0; i<theData.landmarks.length; i++) {
					var LatLng2 = {lat: theData.landmarks[i].geometry.coordinates[1],
						lng: theData.landmarks[i].geometry.coordinates[0]};
					//console.log(LatLng2); 

					var title= theData.landmarks[i].properties.Details;

					console.log(title); 


					//make a marker if the landmark is in a one mile radius 
					var distance = haversineDistance(myLng, myLat, theData.landmarks[i].geometry.coordinates[0],
					 theData.landmarks[i].geometry.coordinates[1]); 

					title+="Distance from me "+distance; 
					if (distance <= 1.0)
					{
							console.log(distance); 
							var m = makeMarker(title, LatLng2, "landmark");  
					}

				} 
				//index in data array that denotes closest landmark
				var closeLandmark = 0; 
				var distance = haversineDistance(myLng, myLat, theData.landmarks[0].geometry.coordinates[0],
					 theData.landmarks[0].geometry.coordinates[1]); 

				for(i=1; i<theData.landmarks.length; i++) {
					newDistance = haversineDistance(myLng, myLat, theData.landmarks[i].geometry.coordinates[0],
					 theData.landmarks[i].geometry.coordinates[1]); 

			

					if(newDistance < distance){
						closeLandmark = i; 
					}

				}
				console.log(closeLandmark); 
				var coordinates = [
				    {lat: myLat, lng: myLng},
				    {lat: theData.landmarks[closeLandmark].geometry.coordinates[1], lng: theData.landmarks[closeLandmark].geometry.coordinates[0]}
 				 ];

				var line = new google.maps.Polyline ({
					path: coordinates,
   					geodesic: true,
				    strokeColor: 'blue',
				    strokeOpacity: 1.0,
				    strokeWeight: 2
				}); 
				line.setMap(map); 
	 	}

	 	
	}

	myRequest.send("login=ELMER_MADDEN&lat="+myLat+"&lng="+myLng); 
	console.log("theoretically, you sent your location!");  
}

function renderMap(){
		me = new google.maps.LatLng(myLat, myLng);
		map.panTo(me);

		makeMarker("Here I Am!", me, "me"); 
		sendLocation(); 
}

function makeMarker(title, LatLng, key){

	var image; 
	if (key == "me"){
		image = "icon1.png"; 
	}
	if (key == "landmark"){
		image = "icon2.png"; 
	}

	var marker = new google.maps.Marker({
			position: LatLng,
			title: title, 
			icon: image
	});
	marker.setMap(map);

	google.maps.event.addListener(marker, 'click', function() {
						infowindow.setContent(this.title);
						infowindow.open(map, this);
	}); 
}
//NOTE: this is from stackoverflow,http://stackoverflow.com/questions/14560999/using-the-haversine-formula-in-javascript, modified slightly
function haversineDistance(lon1, lat1, lon2, lat2) {

var R = 6371; // km

  var x1 = lat2 - lat1;
  var dLat = toRad(x1);

  var x2 = lon2 - lon1;
  var dLon = toRad(x2); 

  var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
    Math.sin(dLon / 2) * Math.sin(dLon / 2);
  var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  var d = R * c;

  //convert to miles 
  d /= 1.60934;

  return d;
}

function toRad(x) {
    return x * Math.PI / 180;
  }

</script>


 
</body>

</html>